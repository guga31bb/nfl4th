---
title: "Get Started with nfl4th"
author: "Ben Baldwin"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(dplyr.summarise.inform = FALSE)
```

First load the packages and some data.

```{r setup, message = FALSE}
library(nfl4th)
library(tidyverse)

data <- nflfastR::load_pbp(2020)
```

## Feeding in nflfastR data

Here's how to calculate all probs from one week in the 2020 season:

```{r ex1}
tictoc::tic("All plays from one week")
data %>%
  dplyr::filter(week == 1) %>%
  nfl4th::add_4th_probs() %>%
  dplyr::filter(down == 4) %>%
  utils::head(10) %>%
  dplyr::select(
    posteam, ydstogo, yardline_100, posteam, go_boost, first_down_prob, 
    wp_fail, wp_succeed, go_wp, fg_make_prob, miss_fg_wp, make_fg_wp, 
    fg_wp, punt_wp
  ) %>%
  knitr::kable(digits = 2)
tictoc::toc()
```

But this kind of takes a long time since it's a whole season. If you want a sub-sample, filter **at the game level** before invoking the function because the win probability model needs all plays in a game in order to work (i.e., not just the 4th downs or one team's plays). This is because it has to figure out which team received the opening kickoff.

```{r ex2}
tictoc::tic("One game")
data %>%
  dplyr::filter(week == 20, home_team == "GB") %>%
  nfl4th::add_4th_probs() %>%
  dplyr::filter(down == 4) %>%
  dplyr::select(
    posteam, ydstogo, yardline_100, posteam, go_boost, first_down_prob, 
    wp_fail, wp_succeed, go_wp, fg_make_prob, miss_fg_wp, make_fg_wp, 
    fg_wp, punt_wp
  ) %>%
  knitr::kable(digits = 2)
tictoc::toc()
```

We see the infamous field goal at the bottom.

Let's input the play ourselves to see if we can get the same thing. The below shows the bare minimum amount of information that has to be fed to `nfl4th` in order to compute 4th down decision recommendations.

The reason teams from a specific game have to be used is that the model depends on factors such as point spread, team totals, and indoor/outdoor and the program automatically looks these up so that users don't have to provide them.

## Calculations from user input

```{r ex3}
one_play <- tibble::tibble(
  
  # things to help find the right game (use "reg" or "post")
  home_team = "GB",
  away_team = "TB",
  posteam = "GB",
  type = "post",
  season = 2020,
  
  # information about the situation
  qtr = 4,
  quarter_seconds_remaining = 129,
  ydstogo = 8,
  yardline_100 = 8,
  score_differential = -8,

  home_opening_kickoff = 0,
  posteam_timeouts_remaining = 3,
  defteam_timeouts_remaining = 3
)

one_play %>%
  nfl4th::add_4th_probs() %>%
  dplyr::select(
    posteam, ydstogo, yardline_100, posteam, go_boost, first_down_prob, 
    wp_fail, wp_succeed, go_wp, fg_make_prob, miss_fg_wp, make_fg_wp, 
    fg_wp, punt_wp
  ) %>%
  knitr::kable(digits = 2)
```

## Make a summary table

Put the play above into a table. This function only works with one play at a time since it makes a table using the results from the play.

```{r table1}
one_play %>%
  nfl4th::add_4th_probs() %>%
  nfl4th::make_table_data() %>%
  knitr::kable(digits = 1)
```

## Make a summary table for a 2-point decision

Let's put in the situation that would have happened if the Packers had scored a touchdown on the 4th & 8. We don't need a calculator to know that they should have gone for two, but what does the model say?

```{r table2}
another <- tibble::tibble(
  
  # things to help find the right game (use "reg" or "post")
  home_team = "GB",
  away_team = "TB",
  posteam = "GB",
  type = "post",
  season = 2020,
  
  # information about the situation
  qtr = 4,
  quarter_seconds_remaining = 123,
  score_differential = -2,

  home_opening_kickoff = 0,
  posteam_timeouts_remaining = 3,
  defteam_timeouts_remaining = 3
)

another %>%
  nfl4th::add_2pt_probs() %>%
  nfl4th::make_2pt_table_data() %>%
  knitr::kable(digits = 1)
```

Note that the go for 2 probability here is identical to the win probability associated with a successful 4th down conversion above because the 4th down model assumes that the Packers would go for 2 if they scored.

## Check coaches' alignment with the model

```{r coaches}
library(gt)

calculated <- data %>%
  nfl4th:::add_4th_probs() %>%
  dplyr::filter(down == 4, !is.na(go_boost)) 
```

```{r big-table, echo = FALSE}
calculated %>%
  dplyr::mutate(go = ifelse((rush == 1 | pass == 1) & !play_type_nfl %in% c("PUNT", "FIELD_GOAL"), 100, 0)) %>%
  dplyr::group_by(posteam, game_id, series) %>%
  dplyr::slice(1) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(type = dplyr::case_when(
    go_boost >= 4 ~ "Definitely go for it",
    go_boost > 1 & go_boost < 4 ~ "Probably go for it",
    go_boost >= -1 & go_boost <= 1 ~ "Toss-up",
    go_boost < -1 & go_boost > -4 ~ "Probably kick",
    go_boost <= -4 ~ "Definitely kick"
  )) %>%
  dplyr::group_by(type) %>%
  dplyr::summarize(go = mean(go), n = dplyr::n()) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(-go) %>%
  gt::gt() %>%
  gt::cols_label(
    type = "Recommendation",
    go = "Went for it %",
    n = "Plays"
  ) %>%
  gt::tab_style(
    style = gt::cell_text(color = "black", weight = "bold"),
    locations = list(
      gt::cells_row_groups(),
      gt::cells_column_labels(dplyr::everything())
    )
  ) %>% 
  gt::tab_options(
    row_group.border.top.width = gt::px(3),
    row_group.border.top.color = "black",
    row_group.border.bottom.color = "black",
    table_body.hlines.color = "white",
    table.border.top.color = "black",
    table.border.top.width = gt::px(1),
    table.border.bottom.color = "white",
    table.border.bottom.width = gt::px(1),
    column_labels.border.bottom.color = "black",
    column_labels.border.bottom.width = gt::px(2),
    data_row.padding = gt::px(2),
    table.font.size = gt::px(16L)
  ) %>%
  gt::fmt_number(
    columns = dplyr::vars(go), decimals = 0
  ) %>%
  gt::cols_align(
    columns = 2:3,
    align = "center"
  ) %>% 
  gt::tab_header(title = "NFL team decision-making by go recommendation, 2020") %>%
  gt::tab_source_note(gt::md('**Notes**: "Definitely" recommendations are greater than 4 percentage point advantage,<br> "probably" 1-4 percentage points'))

```

Thus, we can see that the model is strongly aligned to what coaches do.
